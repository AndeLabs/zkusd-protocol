import * as bitcoin from 'bitcoinjs-lib';
import ECPairFactory from 'ecpair';
import * as ecc from 'tiny-secp256k1';

const ECPair = ECPairFactory(ecc);
bitcoin.initEccLib(ecc);

const TESTNET4 = {
  messagePrefix: '\x18Bitcoin Signed Message:\n',
  bech32: 'tb',
  bip32: { public: 0x043587cf, private: 0x04358394 },
  pubKeyHash: 0x6f,
  scriptHash: 0xc4,
  wif: 0xef,
};

const WIF_KEY = 'cPcsryL9DZi2HjM1saec7aa8k25RTD2poe7SLph6yJDciCQZUPX7';
const UNSIGNED_TX_HEX = '0200000001d40a8cb7221793c4eadf287ff50c4e8f121ba3c1487c8a7888295aa038138b7e0300000000ffffffff0423020000000000001600141aa9f50635832ae98aa07e397aa0b2694175679df8070000000000001600141db4ded10fa155036bfb40717ea68022be899fbb0000000000000000fdb3046a057370656c6c4da90482a36776657273696f6e09627478a1646f75747381a100a66870726f746f636f6ca770746f74616c5f636f6c6c61746572616c006a746f74616c5f6465627400726163746976655f7661756c745f636f756e740069626173655f726174651832756c6173745f6665655f7570646174655f626c6f636b006561646d696e98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a1718486969735f706175736564f46e7a6b7573645f746f6b656e5f69649820184a18b418dd186518460718c818e0186f187e181f161863186618cf18cc1878183c18df188018a9182f18220218d81883186d1893187a186a18ba147173746162696c6974795f706f6f6c5f6964982018b91841182c18a518d818ed186c18a3184d185b1831186c18a5181c18960c188b18c6189a18a9186d18e4186718c918e418eb187b18bf18ab182418e318206f70726963655f6f7261636c655f6964982018ee187718940518f8188f18890c18681858181e1871186b0d18ca18d018571862184409184118a618aa02184818c7182218a118ed18e0185918436b6163746976655f706f6f6c98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a1718486c64656661756c745f706f6f6c98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a171848716170705f7075626c69635f696e70757473a183616e98200000000000000000000000000000000000000000000000000000000000000000982018a21835189b185a1848111718a918be181918f818f318fa182118e118d9187918ba18c518bf18d1186c189418e018a4186c182b18c11832186c1883187df699010418a41859184c18590d182f185a18c018ec1418d91893186718e118e818c6184218a3189f186e18dd18310b18211886182818ba1887185a1716187a1853189518c518d9181918c5183918c6189a1881186f181c187118c50a186e181a182002187218d718ee189a18de188d18fa18d1189318f6189b187012184318c618a118a1181a18d3187c189418c618bf18de1870186218881843186918c718eb18c5185f183c18eb18c5183118cb1897186e18f718d7185518b8121846188018de18f6181b183118a2187718321830189518a9185b185218a1186f187d1852182918cc18ba184118e418fa1830184318d218511855182c18ed181e18601827184018af182118ac0618d81318191855181d18a118ca18d4185f0d18721893187b18a2185d0e1840184318a81837189f18ce18e604185518e910183718ce001818189512189018491827187d1822185e18fc189418f9186d18ff18a6184118d8182d18d618ea188518c10918841872181a182a18e2183b187f184f0518ac188d182718c31870187318ef0018770018841829188018861866184c18e318ee18fc18ec18d318f21896185d188513186b18da18d8182518e513186c18ed18dc18de18b9185d0118a6184518bb18e718de151831187318561861181818551863182903181b181d1848189118f318e718b218a518ee0a980f00000000001600141aa9f50635832ae98aa07e397aa0b2694175679d00000000';
const INPUT_VALUE = BigInt(1027322);

async function main() {
  const keyPair = ECPair.fromWIF(WIF_KEY, TESTNET4);
  const tx = bitcoin.Transaction.fromHex(UNSIGNED_TX_HEX);
  const psbt = new bitcoin.Psbt({ network: TESTNET4 });

  // Add input
  psbt.addInput({
    hash: tx.ins[0].hash,
    index: tx.ins[0].index,
    sequence: tx.ins[0].sequence,
    witnessUtxo: {
      script: bitcoin.payments.p2wpkh({ pubkey: keyPair.publicKey, network: TESTNET4 }).output!,
      value: INPUT_VALUE,
    },
  });

  // Add all outputs
  for (const out of tx.outs) {
    psbt.addOutput({
      script: out.script,
      value: out.value,
    });
  }

  // Sign
  psbt.signInput(0, keyPair);
  psbt.finalizeAllInputs();
  const signedHex = psbt.extractTransaction().toHex();
  console.log('Signed TX hex:', signedHex);

  // Broadcast
  console.log('\nBroadcasting...');
  const resp = await fetch('https://mempool.space/testnet4/api/tx', {
    method: 'POST',
    body: signedHex,
    headers: { 'Content-Type': 'text/plain' },
  });

  if (resp.ok) {
    const txid = await resp.text();
    console.log('SUCCESS! TXID:', txid);
  } else {
    const err = await resp.text();
    console.error('Broadcast failed:', resp.status, err);
  }
}

main().catch(console.error);
