import * as bitcoin from 'bitcoinjs-lib';
import ECPairFactory from 'ecpair';
import * as ecc from 'tiny-secp256k1';

const ECPair = ECPairFactory(ecc);
bitcoin.initEccLib(ecc);

const TESTNET4 = {
  messagePrefix: '\x18Bitcoin Signed Message:\n',
  bech32: 'tb',
  bip32: { public: 0x043587cf, private: 0x04358394 },
  pubKeyHash: 0x6f,
  scriptHash: 0xc4,
  wif: 0xef,
};

const WIF_KEY = 'cPcsryL9DZi2HjM1saec7aa8k25RTD2poe7SLph6yJDciCQZUPX7';
const UNSIGNED_TX_HEX = '0200000001cbbb12e96f43a8b88723f1cfdc8206bf1c25482c547a0b26e771a22c28899adc0300000000ffffffff0423020000000000001600141aa9f50635832ae98aa07e397aa0b2694175679df8070000000000001600141db4ded10fa155036bfb40717ea68022be899fbb0000000000000000fda8046a057370656c6c4d9e0482a36776657273696f6e09627478a1646f75747381a100a66870726f746f636f6ca770746f74616c5f636f6c6c61746572616c006a746f74616c5f6465627400726163746976655f7661756c745f636f756e740069626173655f726174651832756c6173745f6665655f7570646174655f626c6f636b006561646d696e98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a1718486969735f706175736564f46e7a6b7573645f746f6b656e5f6964982018a0183018581896183a185218e418b7189418a318d90518c118c1186601187718f916182118b818f3189d183b18631821189f1418b9061868167173746162696c6974795f706f6f6c5f6964982018b91841182c18a518d818ed186c18a3184d185b1831186c18a5181c18960c188b18c6189a18a9186d18e4186718c918e418eb187b18bf18ab182418e318206f70726963655f6f7261636c655f6964982018ee187718940518f8188f18890c18681858181e1871186b0d18ca18d018571862184409184118a618aa02184818c7182218a118ed18e0185918436b6163746976655f706f6f6c98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a1718486c64656661756c745f706f6f6c98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a171848716170705f7075626c69635f696e70757473a183616e98200000000000000000000000000000000000000000000000000000000000000000982018a21835189b185a1848111718a918be181918f818f318fa182118e118d9187918ba18c518bf18d1186c189418e018a4186c182b18c11832186c1883187df699010418a41859184c18591829185e0b18601893141884184318a418f3189c18b318db1899184418fd18670b1887188e18951883181c18ee1894186818db18f118490a187918d4181a18aa1853188818f718f4189d1898184b1861186718a0185e18a1183f184c185e18fa18c40c184918b3188602181c18c5183818d318e618d518ed185616189a18ca18df1840187b030618c018ec18ec13189318d518961831182f18f50b18b118a618691862185c18d7182f18bd182b188a18fd18e0187a03186e18a51844185318a71868183c184618db0c181b18c10c1893185618581860186018471895182318f918701318e718d901185417182c18a110186e187918fa18b418ea1855187e18a60818d318e118b318e518ee18da18de181818da18680c183418ff18c0187e18440818f818c40a187318af0f184e0c1819182c18341827182f18b918180c188c18e1161852188718dc187f188b18b50318df18aa1868189e181f185518e718ca188f184418ff18190218e1185518741881188a184a18d515186f18cb18dc1838184b182518af186218c718f61847187018ff18e908185b188f18b21886181a18c518f20f1866186718470b18bc1318a4186418b018b818b41829181e1844186d18f218ec18a6183f184718cb111864189c18f0185e186a181c18cd1831093b210800000000001600141aa9f50635832ae98aa07e397aa0b2694175679d00000000';
const INPUT_VALUE = BigInt(538133);

async function main() {
  const keyPair = ECPair.fromWIF(WIF_KEY, TESTNET4);
  const tx = bitcoin.Transaction.fromHex(UNSIGNED_TX_HEX);
  const psbt = new bitcoin.Psbt({ network: TESTNET4 });

  psbt.addInput({
    hash: tx.ins[0].hash,
    index: tx.ins[0].index,
    sequence: tx.ins[0].sequence,
    witnessUtxo: {
      script: bitcoin.payments.p2wpkh({ pubkey: keyPair.publicKey, network: TESTNET4 }).output!,
      value: INPUT_VALUE,
    },
  });

  for (const out of tx.outs) {
    psbt.addOutput({ script: out.script, value: out.value });
  }

  psbt.signInput(0, keyPair);
  psbt.finalizeAllInputs();
  const signedHex = psbt.extractTransaction().toHex();

  console.log('Broadcasting VaultManager V4...');
  const resp = await fetch('https://mempool.space/testnet4/api/tx', {
    method: 'POST',
    body: signedHex,
    headers: { 'Content-Type': 'text/plain' },
  });

  if (resp.ok) {
    const txid = await resp.text();
    console.log('SUCCESS! VaultManager V4 TXID:', txid);
  } else {
    const err = await resp.text();
    console.error('Broadcast failed:', resp.status, err);
  }
}

main().catch(console.error);
