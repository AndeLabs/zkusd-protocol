import * as bitcoin from 'bitcoinjs-lib';
import ECPairFactory from 'ecpair';
import * as ecc from 'tiny-secp256k1';

const ECPair = ECPairFactory(ecc);
bitcoin.initEccLib(ecc);

const TESTNET4 = {
  messagePrefix: '\x18Bitcoin Signed Message:\n',
  bech32: 'tb',
  bip32: { public: 0x043587cf, private: 0x04358394 },
  pubKeyHash: 0x6f,
  scriptHash: 0xc4,
  wif: 0xef,
};

const WIF_KEY = 'cPcsryL9DZi2HjM1saec7aa8k25RTD2poe7SLph6yJDciCQZUPX7';

async function signAndBroadcast(label: string, unsignedHex: string, inputValue: bigint) {
  const keyPair = ECPair.fromWIF(WIF_KEY, TESTNET4);
  const tx = bitcoin.Transaction.fromHex(unsignedHex);
  const psbt = new bitcoin.Psbt({ network: TESTNET4 });

  psbt.addInput({
    hash: tx.ins[0].hash,
    index: tx.ins[0].index,
    sequence: tx.ins[0].sequence,
    witnessUtxo: {
      script: bitcoin.payments.p2wpkh({ pubkey: keyPair.publicKey, network: TESTNET4 }).output!,
      value: inputValue,
    },
  });

  for (const out of tx.outs) {
    psbt.addOutput({ script: out.script, value: out.value });
  }

  psbt.signInput(0, keyPair);
  psbt.finalizeAllInputs();
  const signedHex = psbt.extractTransaction().toHex();

  console.log(`Broadcasting ${label}...`);
  const resp = await fetch('https://mempool.space/testnet4/api/tx', {
    method: 'POST',
    body: signedHex,
    headers: { 'Content-Type': 'text/plain' },
  });

  if (resp.ok) {
    const txid = await resp.text();
    console.log(`SUCCESS! ${label} TXID: ${txid}`);
    return txid;
  } else {
    const err = await resp.text();
    console.error(`FAILED ${label}: ${resp.status} ${err}`);
    throw new Error(err);
  }
}

const VM_V5_HEX = '02000000014cfdf5a9fef6470d2b7fdb84bd8308905e833ac2dba3020ecdadbe15ef44a1f70300000000ffffffff0423020000000000001600141aa9f50635832ae98aa07e397aa0b2694175679df8070000000000001600141db4ded10fa155036bfb40717ea68022be899fbb0000000000000000fdb3046a057370656c6c4da90482a36776657273696f6e09627478a1646f75747381a100a66870726f746f636f6ca770746f74616c5f636f6c6c61746572616c006a746f74616c5f6465627400726163746976655f7661756c745f636f756e740069626173655f726174651832756c6173745f6665655f7570646174655f626c6f636b006561646d696e98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a1718486969735f706175736564f46e7a6b7573645f746f6b656e5f69649820184118c9183118c0181b188a188f0e1897184718f4183f18aa1218b3189118c2184c183f18be18ff189018c01889031888187618a118671859181c18957173746162696c6974795f706f6f6c5f6964982018b91841182c18a518d818ed186c18a3184d185b1831186c18a5181c18960c188b18c6189a18a9186d18e4186718c918e418eb187b18bf18ab182418e318206f70726963655f6f7261636c655f6964982018ee187718940518f8188f18890c18681858181e1871186b0d18ca18d018571862184409184118a618aa02184818c7182218a118ed18e0185918436b6163746976655f706f6f6c98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a1718486c64656661756c745f706f6f6c98200f18ef187218e81828186c0d18d818d518dd1856189e189304183318c3182218330d18331886185018ad18c118aa0a18450218d3185a171848716170705f7075626c69635f696e70757473a183616e98200000000000000000000000000000000000000000000000000000000000000000982018a21835189b185a1848111718a918be181918f818f318fa182118e118d9187918ba18c518bf18d1186c189418e018a4186c182b18c11832186c1883187df699010418a41859184c18591822184318931837183f188618c118bc1874183f18b4186818b218a218e318a318b7187e0e18c018a318a0182018d918f618e91899188918c618c318d818bd06184918f3183b18ec183c18e0001829183218271891186518e018ac185218791718181858181818b818670200101874182b185d1855188618530718751825186b0c1844189418d418dd18b7189a188c18960718db187b187f1867184818900c1890184b18cc182218551869183a18cb15185a18ea1418da181a187818490218fb18c21835184218c2183918dd18f6188c0d184918fb1518b018f5188618b2185218fd18441897189b189518c018d51898182b18e0184918d7183211189018340e182c1865185518be188e18a018a9183418b118f718d2182013184f18ed18411822183718ce06188705184d06181c1887183318b718211884182e18fc18e718bb18e118c7189418dc188e1878189b189918aa18ec183618d1186d18a018bd186518dd182b186e1889185e07185318dd18e7187b186b1850185318c5188b18f7189318b1187a185218fe182f1833188a1897181a18f91821187c189a0c1866187718c218a418c5185811184c1859185b18871854183a18e7183b18d8185e187418330c18f5184318c81841187818b71848187f16185c1846188f181d1867189418d5182f18bae4fb0700000000001600141aa9f50635832ae98aa07e397aa0b2694175679d00000000';

signAndBroadcast('VaultManager V5', VM_V5_HEX, BigInt(528596)).catch(console.error);
