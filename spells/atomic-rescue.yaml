# zkUSD Atomic Rescue Spell
# Allow third party to rescue a distressed vault before liquidation
#
# Rescuer provides zkUSD to reduce vault debt
# Rescuer receives proportional BTC collateral at favorable rate
# Vault owner keeps remaining position (better than liquidation)
#
# Benefit over liquidation:
# - Vault owner: Keeps position, no liquidation penalty
# - Rescuer: Gets BTC at slight discount (rescue_discount_bps)
# - Protocol: Lower bad debt risk, no stability pool depletion
#
# Based on "Trove rescue" concept from Liquity community discussions

version: 8

apps:
  # Vault Manager NFT
  $00: n/${vault_manager_app_id}/${vault_manager_vk}
  # zkUSD Token
  $01: t/${zkusd_app_id}/${zkusd_vk}
  # Rescue Offer NFT (represents standing offer to rescue)
  $02: n/${rescue_offer_app_id}/${rescue_offer_vk}

ins:
  # Input 1: Distressed vault (ICR approaching liquidation threshold)
  - utxo_id: ${vault_utxo}
    charms:
      $00:
        id: ${vault_id}
        owner: ${vault_owner}
        collateral: ${vault_collateral}
        debt: ${vault_debt}
        created_at: ${created_at}
        last_updated: ${last_updated}
        status: 0  # Active
        interest_rate_bps: ${interest_rate}
        accrued_interest: ${accrued_interest}
        redistributed_debt: ${redistributed_debt}
        redistributed_collateral: ${redistributed_collateral}
        insurance_balance: ${insurance_balance}

  # Input 2: Rescue offer from rescuer
  - utxo_id: ${rescue_offer_utxo}
    charms:
      $02:
        rescuer: ${rescuer_pubkey}
        max_debt_to_cover: ${max_rescue_amount}
        min_collateral_ratio: ${min_cr}     # Min ICR to accept (e.g., 115%)
        max_collateral_ratio: ${max_cr}     # Max ICR to accept (e.g., 150%)
        discount_bps: ${rescue_discount}    # e.g., 200 = 2% discount on BTC
        expiry_block: ${offer_expiry}

  # Input 3: zkUSD from rescuer to cover debt
  - utxo_id: ${zkusd_utxo}
    charms:
      $01: ${rescue_amount}

outs:
  # Output 1: Rescued vault (reduced debt, reduced collateral)
  - address: ${vault_owner}
    charms:
      $00:
        id: ${vault_id}
        owner: ${vault_owner}
        collateral: ${new_collateral}       # vault_collateral - btc_to_rescuer
        debt: ${new_debt}                   # vault_debt - rescue_amount
        created_at: ${created_at}
        last_updated: ${current_block}
        status: 0  # Still Active
        interest_rate_bps: ${interest_rate}
        accrued_interest: ${new_interest}
        redistributed_debt: ${redistributed_debt}
        redistributed_collateral: ${redistributed_collateral}
        insurance_balance: ${insurance_balance}

  # Output 2: BTC to rescuer (at discounted rate)
  - address: ${rescuer_address}
    charms: {}
    # BTC amount = (rescue_amount / btc_price) * (1 + discount_bps/10000)

  # Output 3: Updated rescue offer (if partially used)
  # Omit if fully consumed
  - address: ${rescuer_address}
    charms:
      $02:
        rescuer: ${rescuer_pubkey}
        max_debt_to_cover: ${remaining_offer}  # max_rescue - rescue_amount
        min_collateral_ratio: ${min_cr}
        max_collateral_ratio: ${max_cr}
        discount_bps: ${rescue_discount}
        expiry_block: ${offer_expiry}

# Validation Rules:
# 1. Vault ICR must be between min_cr and max_cr
# 2. rescue_amount <= max_debt_to_cover
# 3. current_block < offer_expiry
# 4. New vault ICR must be >= MIN_COLLATERAL_RATIO (110%)

