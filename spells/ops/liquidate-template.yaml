# =============================================================================
# zkUSD Liquidate Vault Spell (Operational Template)
# =============================================================================
# Liquidate an undercollateralized vault (ICR < 110%)
#
# DEPLOYMENT VALUES:
#   Vault Manager VK:   56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
#   Vault Manager ID:   3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0
#   Stability Pool VK:  ace2894585f8820a3b230ab57a24df35de1dd4b7234d9d38bde78fa643871752
#   Stability Pool ID:  c11c5451c834f54ed56227b3fb48d366de2c139c2a0f559aeebfb45af8a067bf
#   Token VK:           7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
#
# LIQUIDATION FLOW:
#   1. Anyone can liquidate a vault with ICR < MCR (110%)
#   2. Stability Pool absorbs the debt (burns zkUSD)
#   3. Stability Pool receives the collateral (for depositors)
#   4. Liquidator receives 0.5% bonus + 200 zkUSD gas compensation
#
# PERMISSION: Permissionless - anyone can call if vault is underwater
# =============================================================================

version: 8

apps:
  # Vault Manager NFT: n/{app_id}/{vk}
  $VM: n/3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0/56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
  # zkUSD Token (fungible): t/{app_id}/{vk}
  $TOKEN: t/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
  # Stability Pool NFT: n/{app_id}/{vk}
  $SP: n/c11c5451c834f54ed56227b3fb48d366de2c139c2a0f559aeebfb45af8a067bf/ace2894585f8820a3b230ab57a24df35de1dd4b7234d9d38bde78fa643871752

# Witness data for Liquidate operation
private_inputs:
  $VM:
    op: 22                                    # 0x16 = LIQUIDATE
    vault_id: ${VAULT_ID}                     # 32-byte vault ID

ins:
  # Input 1: Undercollateralized Vault NFT to liquidate
  - utxo_id: ${VAULT_UTXO}
    charms:
      $VM:
        id: ${VAULT_ID}
        owner: ${VAULT_OWNER}
        collateral: ${VAULT_COLLATERAL}       # BTC in sats
        debt: ${VAULT_DEBT}                   # zkUSD with 8 decimals
        created_at: ${CREATED_AT}
        last_updated: ${LAST_UPDATED}
        status: 0                             # Active -> will become 3 (Liquidated)
        interest_rate_bps: ${INTEREST_RATE}
        accrued_interest: ${ACCRUED_INTEREST}
        redistributed_debt: ${REDIST_DEBT}
        redistributed_collateral: ${REDIST_COLL}
        insurance_balance: 0

  # Input 2: Stability Pool state
  - utxo_id: ${SP_STATE_UTXO}
    charms:
      $SP:
        total_zkusd: ${SP_TOTAL_ZKUSD}
        total_btc: ${SP_TOTAL_BTC}
        product_p: ${SP_PRODUCT_P}
        sum_s: ${SP_SUM_S}
        current_epoch: ${SP_EPOCH}
        current_scale: ${SP_SCALE}
        depositor_count: ${SP_DEPOSITORS}

outs:
  # Output 1: Liquidated Vault (zeroed out, status = 3)
  - address: ${VAULT_OWNER}
    charms:
      $VM:
        id: ${VAULT_ID}
        owner: ${VAULT_OWNER}
        collateral: 0                         # All collateral seized
        debt: 0                               # Debt cancelled
        created_at: ${CREATED_AT}
        last_updated: ${CURRENT_BLOCK}
        status: 3                             # Liquidated
        interest_rate_bps: ${INTEREST_RATE}
        accrued_interest: 0
        redistributed_debt: 0
        redistributed_collateral: 0
        insurance_balance: 0

  # Output 2: Updated Stability Pool (absorbed debt, received collateral)
  - address: ${SP_ADDRESS}
    charms:
      $SP:
        total_zkusd: ${SP_NEW_ZKUSD}          # SP_TOTAL - VAULT_DEBT
        total_btc: ${SP_NEW_BTC}              # SP_BTC + VAULT_COLLATERAL - LIQUIDATOR_BONUS
        product_p: ${SP_NEW_P}                # Updated via loss distribution
        sum_s: ${SP_NEW_S}                    # Updated for BTC rewards
        current_epoch: ${SP_NEW_EPOCH}
        current_scale: ${SP_NEW_SCALE}
        depositor_count: ${SP_DEPOSITORS}

  # Output 3: Liquidator bonus (0.5% of collateral = 50 bps)
  - address: ${LIQUIDATOR_ADDRESS}
    charms: {}
    # BTC sats = VAULT_COLLATERAL * 50 / 10000

  # Output 4: Gas compensation to liquidator (200 zkUSD)
  - address: ${LIQUIDATOR_ADDRESS}
    charms:
      $TOKEN: 20000000000                     # 200.00000000 zkUSD

# =============================================================================
# LIQUIDATION MATH EXAMPLE
# =============================================================================
# Vault: 1 BTC collateral, 95,000 zkUSD debt
# BTC Price: $100,000
# ICR = (100,000 * 1) / 95,000 = 105.26% < 110% (MCR) -> LIQUIDATABLE
#
# Liquidation Distribution:
#   - SP absorbs 95,000 zkUSD debt (burns from total_zkusd)
#   - SP receives 99.5% of collateral = 99,500,000 sats
#   - Liquidator receives 0.5% bonus = 500,000 sats
#   - Liquidator receives 200 zkUSD gas compensation
#
# SP P update: new_P = old_P * (1 - debt_offset / total_zkusd)
# SP S update: new_S = old_S + (collateral_per_unit * current_P)
# =============================================================================
