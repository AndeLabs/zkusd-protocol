# =============================================================================
# zkUSD Stability Pool Deposit Spell (Operational Template)
# =============================================================================
# Deposit zkUSD to the Stability Pool to earn liquidation rewards
#
# DEPLOYMENT VALUES:
#   Stability Pool VK:  ace2894585f8820a3b230ab57a24df35de1dd4b7234d9d38bde78fa643871752
#   Stability Pool ID:  c11c5451c834f54ed56227b3fb48d366de2c139c2a0f559aeebfb45af8a067bf
#   Token VK:           7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
#   Token App ID:       a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82
#
# HOW STABILITY POOL WORKS:
#   - Depositors provide zkUSD as "buffer" for liquidations
#   - When vaults are liquidated, SP absorbs the debt
#   - In return, depositors receive BTC collateral (at discount)
#   - Rewards tracked via P (product) and S (sum) accumulators
# =============================================================================

version: 8

apps:
  # zkUSD Token (fungible): t/{app_id}/{vk}
  $TOKEN: t/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
  # Stability Pool NFT: n/{app_id}/{vk}
  $SP: n/c11c5451c834f54ed56227b3fb48d366de2c139c2a0f559aeebfb45af8a067bf/ace2894585f8820a3b230ab57a24df35de1dd4b7234d9d38bde78fa643871752

# Witness data for Deposit operation
private_inputs:
  $SP:
    op: 32                                    # 0x20 = DEPOSIT
    amount: ${DEPOSIT_AMOUNT}                 # zkUSD with 8 decimals

ins:
  # Input 1: zkUSD tokens to deposit
  - utxo_id: ${ZKUSD_UTXO}
    charms:
      $TOKEN: ${ZKUSD_BALANCE}                # Current zkUSD in UTXO

  # Input 2: Current Stability Pool state (for update)
  - utxo_id: ${SP_STATE_UTXO}
    charms:
      $SP:
        total_zkusd: ${SP_TOTAL_ZKUSD}
        total_btc: ${SP_TOTAL_BTC}
        product_p: ${SP_PRODUCT_P}
        sum_s: ${SP_SUM_S}
        current_epoch: ${SP_EPOCH}
        current_scale: ${SP_SCALE}
        depositor_count: ${SP_DEPOSITORS}

outs:
  # Output 1: Updated Stability Pool state
  - address: ${SP_ADDRESS}
    charms:
      $SP:
        total_zkusd: ${SP_NEW_TOTAL}          # SP_TOTAL_ZKUSD + DEPOSIT_AMOUNT
        total_btc: ${SP_TOTAL_BTC}
        product_p: ${SP_PRODUCT_P}
        sum_s: ${SP_SUM_S}
        current_epoch: ${SP_EPOCH}
        current_scale: ${SP_SCALE}
        depositor_count: ${SP_NEW_COUNT}      # +1 if new depositor

  # Output 2: Depositor position NFT (proves ownership)
  - address: ${DEPOSITOR_ADDRESS}
    charms:
      # Depositor-specific NFT charm (separate app or embedded)
      depositor: ${DEPOSITOR_PUBKEY}
      initial_deposit: ${DEPOSIT_AMOUNT}
      snapshot_p: ${SP_PRODUCT_P}             # Capture current P for rewards calc
      snapshot_s: ${SP_SUM_S}
      snapshot_epoch: ${SP_EPOCH}
      snapshot_scale: ${SP_SCALE}

  # Output 3: Change zkUSD (if not depositing entire balance)
  - address: ${DEPOSITOR_ADDRESS}
    charms:
      $TOKEN: ${ZKUSD_CHANGE}                 # ZKUSD_BALANCE - DEPOSIT_AMOUNT

# =============================================================================
# EXAMPLE: Deposit 1,000 zkUSD
# =============================================================================
# DEPOSIT_AMOUNT: 100000000000 (1,000.00000000 zkUSD)
# SP_NEW_TOTAL: SP_TOTAL_ZKUSD + 100000000000
# SP_NEW_COUNT: SP_DEPOSITORS + 1 (if first deposit)
# =============================================================================
