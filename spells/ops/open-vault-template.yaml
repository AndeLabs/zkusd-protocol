# =============================================================================
# zkUSD Open Vault Spell (Operational Template)
# =============================================================================
# Creates a new vault with BTC collateral and mints zkUSD debt
#
# DEPLOYMENT VALUES:
#   Vault Manager VK:  56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
#   Vault Manager ID:  3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0
#   Token VK:          7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
#   Token App ID:      a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82
#
# USAGE:
#   1. Replace ${PLACEHOLDER} values with actual data
#   2. Run: ./scripts/run-operation.sh open-vault <params>
#
# REQUIREMENTS:
#   - BTC UTXO with sufficient collateral
#   - Collateral Ratio >= 110% (MCR)
# =============================================================================

version: 8

apps:
  # Vault Manager NFT: n/{app_id}/{vk}
  $VM: n/3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0/56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
  # zkUSD Token (fungible): t/{app_id}/{vk}
  $TOKEN: t/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903

# Witness data for OpenVault operation
private_inputs:
  $VM:
    op: 16                                    # 0x10 = OPEN_VAULT
    collateral: ${COLLATERAL_SATS}            # BTC in satoshis
    debt: ${DEBT_ZKUSD}                       # zkUSD with 8 decimals

ins:
  # Input 1: BTC collateral UTXO (will be consumed)
  - utxo_id: ${COLLATERAL_UTXO}
    charms: {}

  # Input 2: VaultManager state reference (read-only via refs)
  # Note: For open vault, we reference the global VM state

outs:
  # Output 1: New Vault NFT charm
  - address: ${OWNER_ADDRESS}
    charms:
      $VM:
        id: ${VAULT_ID}                       # SHA256(collateral_utxo)
        owner: ${OWNER_PUBKEY_32}             # 32-byte owner pubkey
        collateral: ${COLLATERAL_SATS}
        debt: ${DEBT_ZKUSD}
        created_at: ${BLOCK_HEIGHT}
        last_updated: ${BLOCK_HEIGHT}
        status: 0                             # Active
        interest_rate_bps: ${INTEREST_RATE}   # e.g., 50 = 0.5% APR
        accrued_interest: 0
        redistributed_debt: 0
        redistributed_collateral: 0
        insurance_balance: 0

  # Output 2: Minted zkUSD tokens to owner
  - address: ${OWNER_ADDRESS}
    charms:
      $TOKEN: ${DEBT_ZKUSD}

  # Output 3: Change BTC (remaining after collateral)
  - address: ${OWNER_ADDRESS}
    charms: {}

# =============================================================================
# EXAMPLE VALUES (for 1 BTC collateral, 50,000 zkUSD debt @ $100k BTC price)
# =============================================================================
# COLLATERAL_SATS: 100000000 (1 BTC)
# DEBT_ZKUSD: 5000000000000 (50,000.00000000 zkUSD)
# ICR = (1 BTC * $100,000) / $50,000 = 200% (safe)
#
# Minimum debt: 200 zkUSD (20000000000)
# =============================================================================
