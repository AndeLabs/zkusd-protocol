# =============================================================================
# zkUSD Adjust Vault Spell (Operational Template)
# =============================================================================
# Atomically adjust vault: add/withdraw collateral AND/OR mint/repay debt
#
# DEPLOYMENT VALUES:
#   Vault Manager VK:  56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
#   Vault Manager ID:  3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0
#   Token VK:          7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
#   Token App ID:      a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82
#
# UTXO ADVANTAGE: All adjustments happen atomically
#   - No partial state changes
#   - Either all succeed or transaction fails
# =============================================================================

version: 8

apps:
  # Vault Manager NFT: n/{app_id}/{vk}
  $VM: n/3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0/56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
  # zkUSD Token (fungible): t/{app_id}/{vk}
  $TOKEN: t/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903

# Witness - specify which operation(s)
# Can combine: ADD_COLLATERAL + MINT_DEBT, etc.
private_inputs:
  $VM:
    op: ${OP_CODE}                            # 0x12=AddColl, 0x13=WithdrawColl, 0x14=MintDebt, 0x15=RepayDebt
    vault_id: ${VAULT_ID}
    collateral: ${COLLATERAL_CHANGE}          # Amount to add/withdraw
    debt: ${DEBT_CHANGE}                      # Amount to mint/repay

ins:
  # Input 1: Existing vault NFT
  - utxo_id: ${VAULT_UTXO}
    charms:
      $VM:
        id: ${VAULT_ID}
        owner: ${OWNER_PUBKEY}
        collateral: ${OLD_COLLATERAL}
        debt: ${OLD_DEBT}
        created_at: ${CREATED_AT}
        last_updated: ${OLD_UPDATED}
        status: 0
        interest_rate_bps: ${INTEREST_RATE}
        accrued_interest: ${OLD_INTEREST}
        redistributed_debt: ${REDIST_DEBT}
        redistributed_collateral: ${REDIST_COLL}
        insurance_balance: ${INSURANCE}

  # Input 2: Additional BTC (if adding collateral)
  - utxo_id: ${BTC_UTXO}
    charms: {}

  # Input 3: zkUSD for repayment (if repaying debt)
  - utxo_id: ${ZKUSD_UTXO}
    charms:
      $TOKEN: ${ZKUSD_FOR_REPAY}

outs:
  # Output 1: Updated vault NFT
  - address: ${OWNER_ADDRESS}
    charms:
      $VM:
        id: ${VAULT_ID}
        owner: ${OWNER_PUBKEY}
        collateral: ${NEW_COLLATERAL}         # OLD + add - withdraw
        debt: ${NEW_DEBT}                     # OLD + mint - repay
        created_at: ${CREATED_AT}
        last_updated: ${CURRENT_BLOCK}
        status: 0
        interest_rate_bps: ${INTEREST_RATE}
        accrued_interest: ${NEW_INTEREST}
        redistributed_debt: ${REDIST_DEBT}
        redistributed_collateral: ${REDIST_COLL}
        insurance_balance: ${INSURANCE}

  # Output 2: Minted zkUSD (if minting more debt)
  - address: ${OWNER_ADDRESS}
    charms:
      $TOKEN: ${MINTED_ZKUSD}

  # Output 3: Withdrawn BTC (if withdrawing collateral)
  - address: ${OWNER_ADDRESS}
    charms: {}

  # Output 4: Change zkUSD (if repaying partial)
  - address: ${OWNER_ADDRESS}
    charms:
      $TOKEN: ${ZKUSD_CHANGE}

# =============================================================================
# OPERATION CODES
# =============================================================================
# ADD_COLLATERAL:      0x12 (18)
# WITHDRAW_COLLATERAL: 0x13 (19)
# MINT_DEBT:           0x14 (20)
# REPAY_DEBT:          0x15 (21)
#
# VALIDATION:
#   - After adjustment, ICR must remain >= MCR (110%)
#   - Cannot withdraw below min collateral
#   - Cannot mint if it would push ICR below MCR
# =============================================================================
