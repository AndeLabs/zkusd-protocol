# =============================================================================
# zkUSD Stability Pool Withdraw Spell (Operational Template)
# =============================================================================
# Withdraw zkUSD from Stability Pool + claim BTC gains
#
# DEPLOYMENT VALUES:
#   Stability Pool VK:  ace2894585f8820a3b230ab57a24df35de1dd4b7234d9d38bde78fa643871752
#   Stability Pool ID:  c11c5451c834f54ed56227b3fb48d366de2c139c2a0f559aeebfb45af8a067bf
#   Token VK:           7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
#   Token App ID:       a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82
#
# REWARDS CALCULATION:
#   - Uses P (product) and S (sum) accumulators
#   - zkUSD_compounded = deposit * (current_P / snapshot_P)
#   - BTC_gains = deposit * (current_S - snapshot_S) / snapshot_P
# =============================================================================

version: 8

apps:
  # zkUSD Token (fungible): t/{app_id}/{vk}
  $TOKEN: t/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
  # Stability Pool NFT: n/{app_id}/{vk}
  $SP: n/c11c5451c834f54ed56227b3fb48d366de2c139c2a0f559aeebfb45af8a067bf/ace2894585f8820a3b230ab57a24df35de1dd4b7234d9d38bde78fa643871752

# Witness data for Withdraw operation
private_inputs:
  $SP:
    op: 33                                    # 0x21 = WITHDRAW
    amount: ${WITHDRAW_AMOUNT}                # zkUSD to withdraw (8 decimals)

ins:
  # Input 1: Depositor position NFT
  - utxo_id: ${DEPOSITOR_UTXO}
    charms:
      # Depositor position data
      depositor: ${DEPOSITOR_PUBKEY}
      initial_deposit: ${INITIAL_DEPOSIT}
      snapshot_p: ${SNAPSHOT_P}
      snapshot_s: ${SNAPSHOT_S}
      snapshot_epoch: ${SNAPSHOT_EPOCH}
      snapshot_scale: ${SNAPSHOT_SCALE}

  # Input 2: Current Stability Pool state
  - utxo_id: ${SP_STATE_UTXO}
    charms:
      $SP:
        total_zkusd: ${SP_TOTAL_ZKUSD}
        total_btc: ${SP_TOTAL_BTC}
        product_p: ${SP_PRODUCT_P}
        sum_s: ${SP_SUM_S}
        current_epoch: ${SP_EPOCH}
        current_scale: ${SP_SCALE}
        depositor_count: ${SP_DEPOSITORS}

outs:
  # Output 1: Updated Stability Pool state
  - address: ${SP_ADDRESS}
    charms:
      $SP:
        total_zkusd: ${SP_NEW_TOTAL}          # SP_TOTAL - WITHDRAW_AMOUNT
        total_btc: ${SP_NEW_BTC}              # SP_BTC - BTC_GAINS
        product_p: ${SP_PRODUCT_P}
        sum_s: ${SP_SUM_S}
        current_epoch: ${SP_EPOCH}
        current_scale: ${SP_SCALE}
        depositor_count: ${SP_NEW_COUNT}      # -1 if full withdrawal

  # Output 2: zkUSD returned to depositor
  - address: ${DEPOSITOR_ADDRESS}
    charms:
      $TOKEN: ${COMPOUNDED_ZKUSD}             # May be less than initial due to liquidations

  # Output 3: BTC gains to depositor
  - address: ${DEPOSITOR_ADDRESS}
    charms: {}
    # BTC sats = calculated BTC gains from liquidations

  # Output 4: Updated depositor position (if partial withdraw)
  - address: ${DEPOSITOR_ADDRESS}
    charms:
      depositor: ${DEPOSITOR_PUBKEY}
      initial_deposit: ${REMAINING_DEPOSIT}
      snapshot_p: ${SP_PRODUCT_P}             # Update snapshots
      snapshot_s: ${SP_SUM_S}
      snapshot_epoch: ${SP_EPOCH}
      snapshot_scale: ${SP_SCALE}

# =============================================================================
# REWARDS MATH (Liquity-style)
# =============================================================================
# COMPOUNDED_DEPOSIT = INITIAL_DEPOSIT * (current_P / snapshot_P)
#   - This is how much zkUSD remains after absorbing liquidations
#
# BTC_GAINS = INITIAL_DEPOSIT * (current_S - snapshot_S) / snapshot_P
#   - This is the BTC earned from liquidated collateral
#
# If current_epoch > snapshot_epoch: deposit fully depleted (compounded = 0)
# =============================================================================
