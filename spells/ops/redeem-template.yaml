# =============================================================================
# zkUSD Redeem Spell (Operational Template)
# =============================================================================
# Redeem zkUSD for BTC from lowest-interest-rate vaults
#
# DEPLOYMENT VALUES:
#   Vault Manager VK:  56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
#   Vault Manager ID:  3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0
#   Token VK:          7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
#   Token App ID:      a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82
#
# REDEMPTION MECHANISM (Liquity V2 style):
#   - Vaults redeemed in order of interest rate (lowest first)
#   - Redeemer receives BTC at oracle price minus fee
#   - Fee = 0.5% base + dynamic component based on base rate
#   - Vault owners lose collateral but debt is reduced proportionally
# =============================================================================

version: 8

apps:
  # Vault Manager NFT: n/{app_id}/{vk}
  $VM: n/3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0/56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
  # zkUSD Token (fungible): t/{app_id}/{vk}
  $TOKEN: t/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903

# Witness data for Redeem operation
private_inputs:
  $VM:
    op: 23                                    # 0x17 = REDEEM
    amount: ${REDEMPTION_AMOUNT}              # zkUSD to redeem (8 decimals)

ins:
  # Input 1: zkUSD to redeem
  - utxo_id: ${ZKUSD_UTXO}
    charms:
      $TOKEN: ${ZKUSD_BALANCE}

  # Input 2: Vault 1 (lowest interest rate)
  - utxo_id: ${VAULT_1_UTXO}
    charms:
      $VM:
        id: ${V1_ID}
        owner: ${V1_OWNER}
        collateral: ${V1_COLLATERAL}
        debt: ${V1_DEBT}
        created_at: ${V1_CREATED}
        last_updated: ${V1_UPDATED}
        status: 0
        interest_rate_bps: ${V1_RATE}         # Lowest rate
        accrued_interest: ${V1_INTEREST}
        redistributed_debt: ${V1_REDIST_D}
        redistributed_collateral: ${V1_REDIST_C}
        insurance_balance: 0

  # Input 3: Vault 2 (second lowest - if needed)
  - utxo_id: ${VAULT_2_UTXO}
    charms:
      $VM:
        id: ${V2_ID}
        owner: ${V2_OWNER}
        collateral: ${V2_COLLATERAL}
        debt: ${V2_DEBT}
        created_at: ${V2_CREATED}
        last_updated: ${V2_UPDATED}
        status: 0
        interest_rate_bps: ${V2_RATE}
        accrued_interest: ${V2_INTEREST}
        redistributed_debt: ${V2_REDIST_D}
        redistributed_collateral: ${V2_REDIST_C}
        insurance_balance: 0

outs:
  # Output 1: BTC to redeemer (minus redemption fee)
  - address: ${REDEEMER_ADDRESS}
    charms: {}
    # BTC sats = (REDEMPTION_AMOUNT / BTC_PRICE) * (1 - REDEMPTION_FEE)

  # Output 2: Updated Vault 1
  - address: ${V1_OWNER}
    charms:
      $VM:
        id: ${V1_ID}
        owner: ${V1_OWNER}
        collateral: ${V1_NEW_COLL}            # Reduced proportionally
        debt: ${V1_NEW_DEBT}                  # Reduced by redeemed amount
        created_at: ${V1_CREATED}
        last_updated: ${CURRENT_BLOCK}
        status: ${V1_NEW_STATUS}              # 2 if fully redeemed
        interest_rate_bps: ${V1_RATE}
        accrued_interest: ${V1_NEW_INTEREST}
        redistributed_debt: ${V1_REDIST_D}
        redistributed_collateral: ${V1_REDIST_C}
        insurance_balance: 0

  # Output 3: Updated Vault 2 (if partially redeemed)
  - address: ${V2_OWNER}
    charms:
      $VM:
        id: ${V2_ID}
        owner: ${V2_OWNER}
        collateral: ${V2_NEW_COLL}
        debt: ${V2_NEW_DEBT}
        created_at: ${V2_CREATED}
        last_updated: ${CURRENT_BLOCK}
        status: ${V2_NEW_STATUS}
        interest_rate_bps: ${V2_RATE}
        accrued_interest: ${V2_NEW_INTEREST}
        redistributed_debt: ${V2_REDIST_D}
        redistributed_collateral: ${V2_REDIST_C}
        insurance_balance: 0

  # Output 4: Redemption fee to protocol treasury
  - address: ${TREASURY_ADDRESS}
    charms: {}
    # BTC sats = fee amount

  # Output 5: zkUSD change (if any)
  - address: ${REDEEMER_ADDRESS}
    charms:
      $TOKEN: ${ZKUSD_CHANGE}

# =============================================================================
# REDEMPTION MATH
# =============================================================================
# BTC_PRICE = from oracle (USD with 8 decimals)
# BASE_FEE = 0.5% (50 bps)
# DYNAMIC_FEE = base_rate from VaultManager
# TOTAL_FEE = BASE_FEE + DYNAMIC_FEE
#
# BTC_RECEIVED = (REDEMPTION_AMOUNT * 10^8 / BTC_PRICE) * (1 - TOTAL_FEE)
#
# Per vault:
#   redeemed_from_vault = min(vault_debt, remaining_to_redeem)
#   collateral_taken = redeemed_from_vault * 10^8 / BTC_PRICE
#   new_vault_debt = old_debt - redeemed_from_vault
#   new_vault_coll = old_coll - collateral_taken
# =============================================================================
