# =============================================================================
# zkUSD Open Vault Test Spell (Corrected)
# =============================================================================
# Creates a new vault with BTC collateral and mints zkUSD
#
# CALCULATION (at $104,000/BTC):
#   Collateral: 2,500,000 sats = 0.025 BTC = $2,600
#   User Debt: 1,800 zkUSD = $1,800
#   Vault Debt: 2,000 zkUSD (includes 200 zkUSD liquidation reserve)
#   ICR = $2,600 / $2,000 = 130% (above 110% MCR)
#
# IMPORTANT: MIN_DEBT = 2000 zkUSD, so user debt must be >= 1800 zkUSD
# =============================================================================

version: 8

apps:
  # Vault Manager NFT (production VK without debug output)
  $VM: n/3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0/3a6a02f4fe4b4b61f03018cabb7995240799fac45323ff766f9ecc3398bb7874

  # zkUSD Token (fungible, production VK without debug output)
  $TOKEN: t/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/355518c664be1dd7f9f9c283feb2c48adf3baa45c88e04324fb52fc11d625235

  # zkUSD Token State NFT (same identity as TOKEN but 'n' tag for state tracking)
  $TOKEN_STATE: n/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/355518c664be1dd7f9f9c283feb2c48adf3baa45c88e04324fb52fc11d625235

  # Price Oracle (reference only)
  $ORACLE: n/8aa4f505cb3e6f7f8d7f553e517dc0c161fd662ce56ce9412ad5dd00991b1ef2/b44db07ac1697704ea7170f4e857c50c4545f0de00dfcc11835dc6efb0c27c32

# Witness for VaultWitness struct
# NOTE: vault_id must be provided for OPEN_VAULT (the new vault's ID)
# NOTE: debt in witness is the "user debt", vault stores debt + LIQUIDATION_RESERVE
# LIQUIDATION_RESERVE = 200 zkUSD = 20000000000
# MIN_DEBT = 2000 zkUSD = 200000000000
# So debt: 180000000000 (1800 zkUSD) -> vault.debt: 200000000000 (2000 zkUSD total)
private_inputs:
  $VM:
    op: 16
    # Vault ID = arbitrary unique 32 bytes for new vault
    vault_id: [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]
    collateral: 2500000
    debt: 180000000000
    flash_purpose: ~
    rescuer_discount: ~
    coverage: ~
    premium: ~
    trigger_icr: ~
    insurance_id: ~
    new_owner: ~

  # Token witness for mint operation (for fungible token)
  $TOKEN:
    op: 2  # OP_MINT
    from: ~  # null for mint
    # to: owner address (same as vault owner)
    to: [213, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    amount: 180000000000  # 1800 zkUSD

  # Token state witness for mint operation (for state NFT)
  $TOKEN_STATE:
    op: 2  # OP_MINT
    from: ~  # null for mint
    # to: owner address (same as vault owner)
    to: [213, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    amount: 180000000000  # 1800 zkUSD

ins:
  # Input 1: BTC collateral UTXO (2,600,000 sats in modified prev_tx)
  - utxo_id: 2d708e72d23850c78d4857c9d83d895b22d188b891f0b64db424fe2dfc6e6be8:2
    charms: {}

  # Input 2: VaultManager global state
  - utxo_id: a6dfdfaa1834eca1203f871f535aa33d2d197518c485e1d7c6dac4ad1b55a7a9:0
    charms:
      $VM:
        # VaultManagerState structure (exact field order matters for serde)
        protocol:
          total_collateral: 0
          total_debt: 0
          active_vault_count: 0
          base_rate: 50
          last_fee_update_block: 0
          admin: [213, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
          is_paused: false
        # Token app_id: a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82
        zkusd_token_id: [166, 179, 87, 12, 132, 6, 77, 114, 220, 102, 135, 208, 48, 145, 84, 70, 158, 250, 106, 66, 127, 211, 193, 105, 30, 101, 109, 97, 114, 69, 92, 130]
        # SP app_id: c11c5451c834f54ed56227b3fb48d366de2c139c2a0f559aeebfb45af8a067bf
        stability_pool_id: [193, 28, 84, 81, 200, 52, 245, 78, 213, 98, 39, 179, 251, 72, 211, 102, 222, 44, 19, 156, 42, 15, 85, 154, 238, 191, 180, 90, 248, 160, 103, 191]
        # Oracle app_id: 8aa4f505cb3e6f7f8d7f553e517dc0c161fd662ce56ce9412ad5dd00991b1ef2
        price_oracle_id: [138, 164, 245, 5, 203, 62, 111, 127, 141, 127, 85, 62, 81, 125, 192, 193, 97, 253, 102, 44, 229, 108, 233, 65, 42, 213, 221, 0, 153, 27, 30, 242]
        active_pool: [172, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        default_pool: [222, 250, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

outs:
  # Output 1: New Vault NFT (Vault struct)
  # NOTE: vault.debt = user_debt + LIQUIDATION_RESERVE = 1800 + 200 = 2000 zkUSD
  - address: tb1qr25l2p34sv4wnz4q0cuh4g9jd9qh2eua6y5awq
    charms:
      $VM:
        # Vault ID must match witness.vault_id
        id: [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]
        owner: [213, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        collateral: 2500000
        debt: 200000000000
        created_at: 113546
        last_updated: 113546
        status: Active
        interest_rate_bps: 50
        accrued_interest: 0
        redistributed_debt: 0
        redistributed_collateral: 0
        insurance_balance: 0

  # Output 2: Updated VaultManager state
  # NOTE: total_debt = vault.debt (includes liquidation reserve)
  - address: tb1qr25l2p34sv4wnz4q0cuh4g9jd9qh2eua6y5awq
    charms:
      $VM:
        protocol:
          total_collateral: 2500000
          total_debt: 200000000000
          active_vault_count: 1
          base_rate: 50
          last_fee_update_block: 0
          admin: [213, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
          is_paused: false
        zkusd_token_id: [166, 179, 87, 12, 132, 6, 77, 114, 220, 102, 135, 208, 48, 145, 84, 70, 158, 250, 106, 66, 127, 211, 193, 105, 30, 101, 109, 97, 114, 69, 92, 130]
        stability_pool_id: [193, 28, 84, 81, 200, 52, 245, 78, 213, 98, 39, 179, 251, 72, 211, 102, 222, 44, 19, 156, 42, 15, 85, 154, 238, 191, 180, 90, 248, 160, 103, 191]
        price_oracle_id: [138, 164, 245, 5, 203, 62, 111, 127, 141, 127, 85, 62, 81, 125, 192, 193, 97, 253, 102, 44, 229, 108, 233, 65, 42, 213, 221, 0, 153, 27, 30, 242]
        active_pool: [172, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        default_pool: [222, 250, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

  # Output 3: Minted zkUSD tokens (user debt, without liquidation reserve)
  - address: tb1qr25l2p34sv4wnz4q0cuh4g9jd9qh2eua6y5awq
    charms:
      $TOKEN: 180000000000

  # Output 4: Updated Token State NFT (total_supply increased by mint amount)
  - address: tb1qr25l2p34sv4wnz4q0cuh4g9jd9qh2eua6y5awq
    charms:
      $TOKEN_STATE:
        # VaultManager app_id is the authorized minter
        authorized_minter: [60, 231, 200, 246, 91, 85, 242, 230, 111, 37, 55, 15, 149, 26, 191, 196, 154, 246, 152, 13, 99, 150, 159, 147, 104, 240, 181, 187, 28, 248, 120, 208]
        total_supply: 180000000000

  # Output 5: BTC change
  - address: tb1qr25l2p34sv4wnz4q0cuh4g9jd9qh2eua6y5awq
    charms: {}

# Reference inputs (read-only) - Oracle for price, Token state for authorization check
refs:
  - utxo_id: e4aeedcc32c72a2e09e29744b7ab5c10224dca8a8a5374a98363b4ad9602b977:0
    charms:
      $ORACLE:
        price:
          price: 10400000000000
          timestamp_block: 0
          source: Mock
          confidence: 100
        operator: [213, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        admin: [213, 79, 168, 49, 172, 25, 87, 76, 85, 3, 241, 203, 213, 5, 147, 74, 11, 171, 60, 238, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        is_active: true
        last_valid_price: 10400000000000

  # Token state NFT (reference for authorization check)
  # authorized_minter = VaultManager app_id
  - utxo_id: 50850413d4a2616891b8603f806c950fc037d4b3f83ed53dc89ce4a81bc65c85:0
    charms:
      $TOKEN_STATE:
        # VaultManager app_id is the authorized minter
        authorized_minter: [60, 231, 200, 246, 91, 85, 242, 230, 111, 37, 55, 15, 149, 26, 191, 196, 154, 246, 152, 13, 99, 150, 159, 147, 104, 240, 181, 187, 28, 248, 120, 208]
        total_supply: 0
