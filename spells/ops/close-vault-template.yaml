# =============================================================================
# zkUSD Close Vault Spell (Operational Template)
# =============================================================================
# Repay all debt and close vault, recovering collateral
#
# DEPLOYMENT VALUES:
#   Vault Manager VK:  56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
#   Vault Manager ID:  3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0
#   Token VK:          7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903
#   Token App ID:      a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82
#
# REQUIREMENTS:
#   - Sufficient zkUSD to repay entire debt + accrued interest
#   - Only vault owner can close
# =============================================================================

version: 8

apps:
  # Vault Manager NFT: n/{app_id}/{vk}
  $VM: n/3ce7c8f65b55f2e66f25370f951abfc49af6980d63969f9368f0b5bb1cf878d0/56ff2636c4d11caeed8a90a608e7c067928e5368f3166d495b85be90af659c44
  # zkUSD Token (fungible): t/{app_id}/{vk}
  $TOKEN: t/a6b3570c84064d72dc6687d0309154469efa6a427fd3c1691e656d6172455c82/7d1a06745a94adf1195fb9f2f987cb48b8c46b814f53167c619c9175cd406903

# Witness data for CloseVault operation
private_inputs:
  $VM:
    op: 17                                    # 0x11 = CLOSE_VAULT
    vault_id: ${VAULT_ID}                     # 32-byte vault ID

ins:
  # Input 1: Vault NFT to close
  - utxo_id: ${VAULT_UTXO}
    charms:
      $VM:
        id: ${VAULT_ID}
        owner: ${OWNER_PUBKEY}
        collateral: ${COLLATERAL}
        debt: ${DEBT}
        created_at: ${CREATED_AT}
        last_updated: ${LAST_UPDATED}
        status: 0                             # Active
        interest_rate_bps: ${INTEREST_RATE}
        accrued_interest: ${ACCRUED_INTEREST}
        redistributed_debt: ${REDIST_DEBT}
        redistributed_collateral: ${REDIST_COLL}
        insurance_balance: 0

  # Input 2: zkUSD to repay entire debt
  - utxo_id: ${ZKUSD_UTXO}
    charms:
      $TOKEN: ${ZKUSD_BALANCE}

outs:
  # Output 1: Recovered collateral (BTC returned to owner)
  # Note: Vault NFT is NOT in outputs = burned/consumed
  - address: ${OWNER_ADDRESS}
    charms: {}
    # BTC sats = COLLATERAL + REDIST_COLL

  # Output 2: Excess zkUSD returned (if any)
  - address: ${OWNER_ADDRESS}
    charms:
      $TOKEN: ${EXCESS_ZKUSD}                 # ZKUSD_BALANCE - TOTAL_DEBT

# =============================================================================
# CALCULATION
# =============================================================================
# TOTAL_DEBT = DEBT + ACCRUED_INTEREST + REDIST_DEBT
# EXCESS_ZKUSD = ZKUSD_BALANCE - TOTAL_DEBT
# RECOVERED_BTC = COLLATERAL + REDIST_COLL
# =============================================================================
