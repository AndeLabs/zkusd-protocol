# zkUSD Flash Mint Spell
# Mint zkUSD, use it atomically, repay with fee - all in single spell
#
# UTXO Advantage: Inherently atomic - no callbacks needed!
# The spell either succeeds completely or fails completely.
# Unlike Ethereum flash loans, there's no callback mechanism required.
#
# Use cases:
# - Arbitrage between DEXs
# - Self-liquidation to avoid penalty
# - Collateral swap without unwinding position
#
# Fee: 0.05% of minted amount (5 basis points)

version: 8

apps:
  # zkUSD Token
  $00: t/${zkusd_app_id}/${zkusd_vk}
  # Protocol Treasury (for fee collection)
  $01: n/${treasury_app_id}/${treasury_vk}

ins:
  # Input 1: Protocol treasury state (tracks flash mint stats)
  - utxo_id: ${treasury_utxo}
    charms:
      $01:
        total_fees: ${treasury_total_fees}
        flash_mint_count: ${flash_mint_count}
        last_flash_block: ${last_flash_block}

  # Input 2: Collateral for operation (what you're doing with the flash minted zkUSD)
  # This varies by use case - could be BTC, another token, etc.
  - utxo_id: ${operation_input_utxo}
    charms: {}

  # Input 3: zkUSD to repay (result of the operation)
  # CRITICAL: This must be >= flash_amount + fee
  - utxo_id: ${repayment_utxo}
    charms:
      $00: ${repayment_amount}  # Must be >= flash_amount * 1.0005

outs:
  # Output 1: Updated treasury (fee collected)
  - address: ${treasury_address}
    charms:
      $01:
        total_fees: ${treasury_new_fees}    # treasury_total_fees + fee
        flash_mint_count: ${new_flash_count}
        last_flash_block: ${current_block}

  # Output 2: Fee payment (0.05% of flash amount)
  - address: ${treasury_address}
    charms:
      $00: ${flash_fee}  # flash_amount * 0.0005

  # Output 3: Profit/result to user (whatever remains after repayment)
  - address: ${user_address}
    charms:
      $00: ${user_profit}  # repayment_amount - flash_amount - fee (if any excess)

  # Output 4: Operation result (BTC or other assets from the operation)
  - address: ${user_address}
    charms: {}
    # Whatever the user gained from using the flash minted zkUSD

# Spell Invariant (enforced by ZK circuit):
# sum(output_zkusd) >= flash_amount + fee
# The flash minted zkUSD never actually leaves - it's created and destroyed in same spell

