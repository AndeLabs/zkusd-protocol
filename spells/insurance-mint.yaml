# zkUSD Insurance Charm Mint Spell
# Purchase liquidation protection for a vault
#
# Insurance provides:
# - Protection against liquidation up to coverage_amount
# - If vault would be liquidated, insurance triggers first
# - Coverage decreases as it's used
#
# Premium calculation: Based on vault's risk profile
# - Higher debt ratio = higher premium
# - Lower interest rate = higher premium (more likely to be redeemed)
#
# Insurance Charms are transferable NFTs - can be traded on secondary market

version: 8

apps:
  # Vault Manager NFT
  $00: n/${vault_manager_app_id}/${vault_manager_vk}
  # zkUSD Token
  $01: t/${zkusd_app_id}/${zkusd_vk}
  # Insurance Charm NFT
  $02: n/${insurance_app_id}/${insurance_vk}
  # Insurance Pool (collects premiums, pays claims)
  $03: n/${insurance_pool_app_id}/${insurance_pool_vk}

ins:
  # Input 1: Vault to insure
  - utxo_id: ${vault_utxo}
    charms:
      $00:
        id: ${vault_id}
        owner: ${vault_owner}
        collateral: ${vault_collateral}
        debt: ${vault_debt}
        created_at: ${created_at}
        last_updated: ${last_updated}
        status: 0
        interest_rate_bps: ${interest_rate}
        accrued_interest: ${accrued_interest}
        redistributed_debt: ${redistributed_debt}
        redistributed_collateral: ${redistributed_collateral}
        insurance_balance: 0  # Will be updated

  # Input 2: zkUSD for premium payment
  - utxo_id: ${premium_utxo}
    charms:
      $01: ${premium_amount}

  # Input 3: Insurance pool state
  - utxo_id: ${insurance_pool_utxo}
    charms:
      $03:
        total_coverage: ${pool_total_coverage}
        total_premiums: ${pool_total_premiums}
        active_policies: ${pool_active_policies}
        claims_paid: ${pool_claims_paid}
        reserve_ratio: ${pool_reserve_ratio}

outs:
  # Output 1: Updated vault with insurance reference
  - address: ${vault_owner}
    charms:
      $00:
        id: ${vault_id}
        owner: ${vault_owner}
        collateral: ${vault_collateral}
        debt: ${vault_debt}
        created_at: ${created_at}
        last_updated: ${current_block}
        status: 0
        interest_rate_bps: ${interest_rate}
        accrued_interest: ${accrued_interest}
        redistributed_debt: ${redistributed_debt}
        redistributed_collateral: ${redistributed_collateral}
        insurance_balance: ${coverage_amount}  # Now insured

  # Output 2: Insurance Charm NFT
  - address: ${vault_owner}
    charms:
      $02:
        policy_id: ${policy_id}
        vault_id: ${vault_id}
        coverage_amount: ${coverage_amount}
        premium_paid: ${premium_amount}
        start_block: ${current_block}
        expiry_block: ${expiry_block}
        coverage_remaining: ${coverage_amount}
        status: 0  # Active

  # Output 3: Updated insurance pool
  - address: ${insurance_pool_address}
    charms:
      $03:
        total_coverage: ${new_total_coverage}    # + coverage_amount
        total_premiums: ${new_total_premiums}    # + premium_amount
        active_policies: ${new_active_policies}  # + 1
        claims_paid: ${pool_claims_paid}
        reserve_ratio: ${new_reserve_ratio}

  # Output 4: Premium to insurance pool
  - address: ${insurance_pool_address}
    charms:
      $01: ${premium_amount}

